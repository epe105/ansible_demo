
---
- name: SCAP STIG Compliance Scanning
  hosts: "{{ server_group }}"
  become: yes
  vars:
    scan_results_dir: "/opt/scap-results"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    
  tasks:
    # - name: Install Apache HTTPD package
    #   ansible.builtin.package:
    #     name: httpd
    #     state: present # Ensures the package is installed

    # - name: Ensure Apache is enabled and running
    #   ansible.builtin.service:
    #     name: httpd
    #     state: started # Ensures the service is running
    #     enabled: yes # Ensures the service starts on boot
    - name: Install OpenSCAP packages
      dnf:
        name:
          - openscap-scanner
          - scap-security-guide
          - openscap-utils
        state: present

    - name: Create results directory
      file:
        path: "{{ scan_results_dir }}"
        state: directory
        mode: '0755'

    - name: Check available SCAP content
      find:
        paths: /usr/share/xml/scap/ssg/content/
        patterns: "ssg-rhel*-ds.xml"
      register: scap_content

    - name: Display available SCAP content
      debug:
        msg: "Available SCAP content: {{ scap_content.files | map(attribute='path') | list }}"

    - name: Determine RHEL version for SCAP content
      set_fact:
        rhel_version: "{{ ansible_distribution_major_version }}"
        scap_content_file: "/usr/share/xml/scap/ssg/content/ssg-rhel{{ ansible_distribution_major_version }}-ds.xml"

    - name: Check if SCAP content exists
      stat:
        path: "{{ scap_content_file }}"
      register: scap_file_check

    - name: List available STIG profiles
      shell: |
        oscap info "{{ scap_content_file }}" | grep -i stig
      register: stig_profiles
      when: scap_file_check.stat.exists

    - name: Display available STIG profiles
      debug:
        msg: "{{ stig_profiles.stdout_lines }}"
      when: scap_file_check.stat.exists

    - name: Run STIG compliance scan
      shell: |
        oscap xccdf eval \
          --profile xccdf_org.ssgproject.content_profile_stig \
          --results "{{ scan_results_dir }}/stig-results-{{ timestamp }}.xml" \
          --report "{{ scan_results_dir }}/stig-report-{{ timestamp }}.html" \
          --oval-results \
          "{{ scap_content_file }}"
      register: scan_result
      failed_when: false
      when: scap_file_check.stat.exists

    - name: Display scan summary
      debug:
        msg: |
          SCAP Scan completed
          Results: {{ scan_results_dir }}/stig-results-{{ timestamp }}.xml
          Report: {{ scan_results_dir }}/stig-report-{{ timestamp }}.html
          Exit code: {{ scan_result.rc }}
      when: scap_file_check.stat.exists

    - name: Generate compliance summary
      shell: |
        oscap xccdf generate report "{{ scan_results_dir }}/stig-results-{{ timestamp }}.xml" > "{{ scan_results_dir }}/compliance-summary-{{ timestamp }}.html"
      when: scap_file_check.stat.exists and scan_result.rc is defined

    - name: Extract pass/fail counts
      shell: |
        oscap xccdf generate report "{{ scan_results_dir }}/stig-results-{{ timestamp }}.xml" | grep -E "(pass|fail|notapplicable|notchecked)" | wc -l
      register: compliance_stats
      when: scap_file_check.stat.exists and scan_result.rc is defined

    - name: Copy results to local machine (optional)
      fetch:
        src: "{{ item }}"
        dest: "./scap-results/"
        flat: yes
      loop:
        - "{{ scan_results_dir }}/stig-results-{{ timestamp }}.xml"
        - "{{ scan_results_dir }}/stig-report-{{ timestamp }}.html"
      when: scap_file_check.stat.exists and scan_result.rc is defined

    - name: Schedule regular scans (optional)
      cron:
        name: "SCAP STIG compliance scan"
        minute: "0"
        hour: "2"
        day: "1"
        job: "oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_stig --results {{ scan_results_dir }}/monthly-stig-results.xml --report {{ scan_results_dir }}/monthly-stig-report.html {{ scap_content_file }}"
        state: present
      when: scap_file_check.stat.exists

    # - name: Copy HTML report to controller
    #   copy:
    #     src: "{{ scan_results_dir }}/stig-report-{{ timestamp }}.html"
    #     dest: "/var/www/html/stig-report-{{ timestamp }}.html"
    #     remote_src: yes
    #     mode: '0644'
    #   when: scap_file_check.stat.exists and scan_result.rc is defined

    - name: Fetch HTML report(s) to controller
      fetch:
        src: "{{ item }}"
        dest: "./scap-results/"
        flat: yes
      loop:
        - "{{ scan_results_dir }}/stig-report-{{ timestamp }}.html"
      register: fetched
      when:
        - scap_file_check.stat.exists
        - scan_result.rc is defined
    
    - name: Append fetched HTML path(s) to global list
      set_stats:
        per_host: no
        data:
          scap_report_files: >-
            {{ (scap_report_files | default([]))
              + (fetched.results | default([]) | map(attribute='dest') | list) }}

- name: Publish SCAP reports to web server
  hosts: "{{ report_server }}"
  vars:
    report_server: PRESIDIOLAB.ORLANDO.WEBSERV
    web_path: /var/www/html/reports/
    ansible_become_user: root
    ansible_become_password: "{{ webadmin_password }}"
    ansible_become_method: sudo
    ansible_user: "{{ webadmin }}"
    ansible_ssh_pass: "{{ webadmin_password }}"
  tasks:
    - name: Copy reports from controller to web server
      copy:
        src: "{{ item }}"    # e.g. /runner/project/scap-results/stig-report-20250808T164206.html
        dest: "{{ web_path }}/"
        mode: '0644'
      loop: "{{ scap_report_files | default([]) }}"
      run_once: true              